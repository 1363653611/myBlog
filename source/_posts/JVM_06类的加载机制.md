---
title: 06 类的加载机制
date: 2019-12-09 18:14:10
tags:
  - JVM
  - java
categories:
  - JVM
  - jav
topdeclare: true
reward: true
---

### 类的加载机制

#### 类的加载时机

#### 生命周期：
- 加载（loading）->验证（verification）->准备（preparation）->解析（resolution）->初始化（initialization）->使用（using）->卸载（unloading）

#### 需要初始化
- 遇到new、getstatic、putstatic或者invokestatic这四条字节码指令时
	- 对应的Java指令
		- 使用new 关键字实例化对象
		- 读取或者设置一个类的静态字段（被final修饰、已在编译器把结果放入常量池的静态字段除外）
		- 调用一个类的静态方法的时候
	- 使用java.lang.reflect包的方法对类进行反射调用时
	- 当初始化一个类的时候，如果父类没初始化，则需要先触发父类的初始化
	- 虚拟机启动时，用户需要指定一个要执行的主类，虚拟机首先会初始化这个主类
	- 动态语言支持时，java.lang.invoke.MehodHandle实例最后解析结果为：ref_getStatic\REF_putStatic\REF_invokStatic的方法句柄。并且这个方法句柄对应的类没有初始化

- 不需要初始化
	- 通过子类引用父类的静态字段，不会导致子类的初始化
	- 通过数组定义来引用类，不会触发此类的初始化
	- 常量在编译阶段会存储在调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发定义常量类的初始化

#### 类的加载过程
- 加载
	- 步骤
		1. 通过全限定性类名获取定义此类的二进制字节流
		 	- 获取位置
				- 从zip包中获取
				- 从网络中获取
				- 运行时计算生成（动态代理）
				- 其他文件生成（jsp）
				- 数据库中读取
		2. 将这个字节流代表的静态存储结构转化为方法区的运行时数据结构
		3. 在内存中生成一个代表这个类的class.lang.Class 对象，作为方法区这个类的各种相关数据的访问入口

- 验证
	- 功能：确保从加载文件的字节流中包含的信息符合当前虚拟机的要求，并不会危害虚拟机自身的安全
	- 验证阶段的4个步骤
		- 文件格式验证
			- 是否以魔数0xCAFEBABE 开头
			- 主、次版本号是否在当前虚拟机处理的范围内
			- 常量池的常量中是否有不被支持的常量类型（tag标志）
			- 指向常量的各种索引值是否有指向不存在的常量或者不符合类型的常量
			- CONSTANT_Utf_8_info 型的常量是否有不符合utf-8 格式的数据
			- class文件中各个部分以及文件本身是否有被删除的或者附加的其他信息

		- 元数据的验证（语义分析）
			- 这个类是否有父类
			- 这个类是否继承了不允许继承的类（被final 修饰的类）
			- 如果这个类不是抽象的类，是否实现了其父类或者接口之中要求要实现的方法
			- 类中的字段、方法是否与父类产生矛盾
		- 字节码验证
			- 目的
				- 数据流和控制流的分析。确定程序语义是合法的，符合逻辑的
				- 对方法体进行校验分析
			- 内容
				- 保证任意时刻操作数栈的数据类型与指令代码都能够配合使用
				- 保证跳转指令不会跳转到方法以外的字节码上
				- 保证方法体中的类型转换是有效的

			- 版本不同
				- 类型推导（jdk1.6之前）
				- 类型检查（jdk1.6 之后）

		- 符号引用验证
			- 目的
				- 该阶段发生在将符号引用转化为直接引用的时候，这个转化动作发生在“解析阶段”
				- 可以看作是类对自身以外（常量池中的各种符号引用）的信息进行匹配性校验
			- 内容
				- 符号引用中通过字符串描述的全限定性类名能否找到对应的类
				- 在指定类中是否存在符合方法的字段描述符以及简单名称所描述的方法和字段
				- 符号引用中的类、字段、方法的访问性是否可被当前类访问

	- 关闭验证：-Xverify:none

- 准备
	- 目的
		- 正式为类变量分配内存并设置类变量初始化值的阶段，这些变量所使用的内存都将在方法区中进行分配
	- 说明
		- 通常情况:(初始化零值)
	- 特殊情况
		- 属性表中存在ConstantValue属性，那在准备阶段变量value就会被初始化为constantValue 属性指定的值
		- javac时会将final 修饰的的属性，对应的value值在constantValue中存放

- 解析
	- 作用
		- 将常量池中的符号引用转化为直接引用的过程
		- 解析动作主要针对：类或者接口、字段、类方法、接口方法、方法类型、方法句柄、调用点限定符
	- 定义
		- 符号引用（symbolic references）
			- 以一组符号来描述所引用的目标，可以是任意形式的字面量，只要是使用时能无歧义的定位到目标即可
		- 直接引用 （direct references）
			- 直接指向目标的指针、相对偏移量或者一个能间接定位到目标的句柄
			- 如果有了直接引用，说明目标必定已经在内存中存在
	- 分类
		- 类或者接口的解析
		- 字段的解析
		- 接口方法解析
		- 。。。。

- 初始化
	- 类加载的最后一步。该阶段才是真正执行类中定义的java代码的阶段
	- 初始化阶段是执行类构造器<cinit>()方法的过程
	- 编译器收集类中的赋值动作，和静态语句快（static{}）,合并并产生结果
	- 子类在执行<cinit>()方法之前，一定优先执行父类的<cinit>()方法

- 使用
- 卸载

#### 类加载器

- 类与类加载器
	- 判断两个类相等
		- 相同的类加载器
		- class对象的equals方法
		- isAssignableFrom()方法
		- isInstance()方法
		- 使用instanceof关键字
- 双亲委派机制模型
	- 加载器的类型
		- 启动类加载器（Bootstrap ClassLoader）
		- 扩展类加载器 Extension Classloader
		- 应用程序类加载器 （Application Classloader）

- 破坏双亲委派模型
